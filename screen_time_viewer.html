<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos - Screen Time Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <style>
        .time-slot {
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .current-session {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .current-session.active {
            background-color: #d4edda;
        }
        .event-badge {
            margin-right: 5px;
        }
        .event-badge.startup { background-color: #28a745; }
        .event-badge.shutdown { background-color: #dc3545; }
        .event-badge.lock { background-color: #ffc107; }
        .event-badge.unlock { background-color: #17a2b8; }
        .event-badge.logout { background-color: #6c757d; }
        .event-badge.system_shutdown { background-color: #dc3545; }
        .session-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #198754;
        }
        .total-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #0d6efd;
        }
        .time-display {
            font-family: monospace;
            font-size: 1.8em;
            font-weight: bold;
        }
        .active-session {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Chronos</h1>
        <p class="lead mb-4">Modern screen time tracking for Linux</p>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <input type="date" id="datePicker" class="form-control">
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="card-title">Today's Total Screen Time:</h5>
                                <div id="totalTime" class="time-display total-time">00:00:00</div>
                            </div>
                            <div class="col-md-6">
                                <h5 class="card-title">Current Session:</h5>
                                <div id="currentSession" class="current-session">
                                    <div class="session-status mb-2">Status: <span id="sessionStatus">Inactive</span></div>
                                    <div class="session-time time-display">Duration: <span id="currentSessionTime">00:00:00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Events Timeline</h5>
                        <div id="timeSlots"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionStart = null;
        let updateInterval = null;

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleString();
        }

        function calculateTimeSlotDuration(startTime, endTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            return (end - start) / 1000; // Convert to seconds
        }

        function updateCurrentSessionDisplay() {
            if (currentSessionStart) {
                const now = new Date();
                const duration = (now - currentSessionStart) / 1000;
                document.getElementById('currentSessionTime').textContent = formatTime(duration);
            }
        }

        function updateCurrentSession(data) {
            const currentSession = data.current_session;
            const sessionStatus = document.getElementById('sessionStatus');
            const currentSessionTime = document.getElementById('currentSessionTime');
            const currentSessionDiv = document.getElementById('currentSession');

            if (currentSession.is_active && currentSession.start_time) {
                sessionStatus.textContent = 'Active';
                currentSessionDiv.classList.add('active');
                currentSessionDiv.classList.remove('inactive');
                currentSessionDiv.classList.add('active-session');

                // Set the start time for the current session
                currentSessionStart = new Date(currentSession.start_time);
                
                // Update the display immediately
                updateCurrentSessionDisplay();
                
                // Start the update interval if not already running
                if (!updateInterval) {
                    updateInterval = setInterval(updateCurrentSessionDisplay, 1000);
                }
            } else {
                sessionStatus.textContent = 'Inactive';
                currentSessionDiv.classList.remove('active', 'active-session');
                currentSessionDiv.classList.add('inactive');
                currentSessionTime.textContent = '00:00:00';
                currentSessionStart = null;
                
                // Clear the update interval
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }
        }

        function displayData(data) {
            const timeSlotsDiv = document.getElementById('timeSlots');
            timeSlotsDiv.innerHTML = '';
            
            // Display total time
            document.getElementById('totalTime').textContent = formatTime(data.total_time);

            // Update current session
            updateCurrentSession(data);

            // Display individual time slots
            const events = data.events;
            for (let i = 1; i < events.length; i++) {
                if (events[i-1].type === 'unlock' && events[i].type === 'lock') {
                    const duration = calculateTimeSlotDuration(events[i-1].timestamp, events[i].timestamp);
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.innerHTML = `
                        <strong>Session ${i}:</strong><br>
                        Start: ${formatDateTime(events[i-1].timestamp)}<br>
                        End: ${formatDateTime(events[i].timestamp)}<br>
                        Duration: ${formatTime(duration)}
                    `;
                    timeSlotsDiv.appendChild(timeSlot);
                }
            }

            // Display all events in chronological order
            const eventsList = document.createElement('div');
            eventsList.className = 'mt-4';
            eventsList.innerHTML = '<h6>All Events</h6>';
            
            events.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'mb-2';
                eventDiv.innerHTML = `
                    <span class="badge event-badge ${event.type}">${event.type}</span>
                    ${formatDateTime(event.timestamp)}
                `;
                eventsList.appendChild(eventDiv);
            });
            
            timeSlotsDiv.appendChild(eventsList);
        }

        async function loadData(date) {
            try {
                const response = await fetch(`screen_time_data/screen_time_${date}.json`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('No data available for this date');
                }
                const data = await response.json();
                displayData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('timeSlots').innerHTML = '<p class="text-danger">No data available for this date</p>';
            }
        }

        // Set up date picker
        const datePicker = document.getElementById('datePicker');
        datePicker.valueAsDate = new Date();
        
        // Load today's data by default
        loadData(new Date().toISOString().split('T')[0]);

        // Load data when date is changed
        datePicker.addEventListener('change', (e) => {
            loadData(e.target.value);
        });

        // Update data every second
        setInterval(() => {
            const currentDate = datePicker.value;
            loadData(currentDate);
        }, 1000);

        // Clean up interval when page is closed
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html> 