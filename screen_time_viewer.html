<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos - Screen Time Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <style>
        .dashboard-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .dashboard-card .card-title {
            margin-bottom: 1rem;
        }
        .dashboard-card .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .time-slot {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
        }
        .current-session {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #0d6efd;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .current-session.active {
            background-color: #d4edda;
            border-color: #198754;
        }
        .event-badge {
            margin-right: 5px;
            padding: 5px 10px;
            border-radius: 15px;
        }
        .event-badge.startup { background-color: #28a745; color: white; }
        .event-badge.shutdown { background-color: #dc3545; color: white; }
        .event-badge.lock { background-color: #ffc107; color: black; }
        .event-badge.unlock { background-color: #17a2b8; color: white; }
        .event-badge.logout { background-color: #6c757d; color: white; }
        .event-badge.system_shutdown { background-color: #dc3545; color: white; }
        .session-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #198754;
        }
        .total-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #0d6efd;
        }
        .time-display {
            font-family: monospace;
            font-size: 1.8em;
            font-weight: bold;
        }
        .active-session {
            animation: pulse 2s infinite;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #0d6efd;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-4 mb-2">Chronos</h1>
                <p class="lead text-muted">Modern screen time tracking for Linux</p>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="card-title">
                        <i class="bi bi-calendar-date me-2"></i>Date Selection
                    </h5>
                    <div class="card-content">
                        <input type="date" id="datePicker" class="form-control">
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history me-2"></i>Today's Total Screen Time
                    </h5>
                    <div class="card-content">
                        <div id="totalTime" class="time-display total-time">00:00:00</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5 class="card-title">
                        <i class="bi bi-activity me-2"></i>Current Session
                    </h5>
                    <div class="card-content">
                        <div id="currentSession" class="current-session">
                            <div class="session-status mb-2">Status: <span id="sessionStatus">Inactive</span></div>
                            <div class="session-time time-display">Duration: <span id="currentSessionTime">00:00:00</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-graph-up me-2"></i>Events Timeline
                    </h5>
                    <div id="summaryStats" class="summary-stats mb-4">
                        <!-- Summary stats will be inserted here -->
                    </div>
                    <div id="timeSlots"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionStart = null;
        let updateInterval = null;

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleString();
        }

        function calculateTimeSlotDuration(startTime, endTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            return (end - start) / 1000; // Convert to seconds
        }

        function updateCurrentSessionDisplay() {
            if (currentSessionStart) {
                const now = new Date();
                const duration = (now - currentSessionStart) / 1000;
                document.getElementById('currentSessionTime').textContent = formatTime(duration);
            }
        }

        function updateCurrentSession(data) {
            const currentSession = data.current_session;
            const sessionStatus = document.getElementById('sessionStatus');
            const currentSessionTime = document.getElementById('currentSessionTime');
            const currentSessionDiv = document.getElementById('currentSession');

            if (currentSession.is_active && currentSession.start_time) {
                sessionStatus.textContent = 'Active';
                currentSessionDiv.classList.add('active');
                currentSessionDiv.classList.remove('inactive');
                currentSessionDiv.classList.add('active-session');

                // Set the start time for the current session
                currentSessionStart = new Date(currentSession.start_time);
                
                // Update the display immediately
                updateCurrentSessionDisplay();
                
                // Start the update interval if not already running
                if (!updateInterval) {
                    updateInterval = setInterval(updateCurrentSessionDisplay, 1000);
                }
            } else {
                sessionStatus.textContent = 'Inactive';
                currentSessionDiv.classList.remove('active', 'active-session');
                currentSessionDiv.classList.add('inactive');
                currentSessionTime.textContent = '00:00:00';
                currentSessionStart = null;
                
                // Clear the update interval
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }
        }

        function calculateSummaryStats(events) {
            const stats = {
                totalSessions: 0,
                totalStartups: 0,
                totalDuration: 0,
                averageSessionDuration: 0
            };

            let currentSession = null;
            let totalDuration = 0;

            for (let i = 0; i < events.length; i++) {
                const event = events[i];
                
                if (event.type === 'startup' || event.type === 'unlock') {
                    currentSession = {
                        start: new Date(event.timestamp)
                    };
                } else if ((event.type === 'lock' || event.type === 'system_shutdown' || event.type === 'logout') && currentSession) {
                    const duration = (new Date(event.timestamp) - currentSession.start) / 1000;
                    totalDuration += duration;
                    stats.totalSessions++;
                    currentSession = null;
                }

                if (event.type === 'startup') {
                    stats.totalStartups++;
                }
            }

            stats.totalDuration = totalDuration;
            stats.averageSessionDuration = stats.totalSessions > 0 ? totalDuration / stats.totalSessions : 0;
            return stats;
        }

        function displaySummaryStats(stats) {
            const summaryStatsDiv = document.getElementById('summaryStats');
            summaryStatsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalSessions}</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatTime(stats.totalDuration)}</div>
                    <div class="stat-label">Total Duration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatTime(stats.averageSessionDuration)}</div>
                    <div class="stat-label">Average Session Duration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalStartups}</div>
                    <div class="stat-label">System Startups</div>
                </div>
            `;
        }

        function displayData(data) {
            // Display total time
            document.getElementById('totalTime').textContent = formatTime(data.total_time);

            // Update current session
            updateCurrentSession(data);

            // Calculate and display summary stats
            const stats = calculateSummaryStats(data.events);
            displaySummaryStats(stats);

            // Display individual time slots
            const timeSlotsDiv = document.getElementById('timeSlots');
            timeSlotsDiv.innerHTML = '';
            
            const events = data.events;
            let currentSession = null;
            let sessionCount = 1;
            
            for (let i = 0; i < events.length; i++) {
                const event = events[i];
                
                if (event.type === 'startup' || event.type === 'unlock') {
                    currentSession = {
                        start: event.timestamp,
                        startType: event.type,
                        startIndex: i
                    };
                } else if ((event.type === 'lock' || event.type === 'system_shutdown' || event.type === 'logout') && currentSession) {
                    const duration = calculateTimeSlotDuration(currentSession.start, event.timestamp);
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.innerHTML = `
                        <strong>Session ${sessionCount}:</strong><br>
                        Start: ${formatDateTime(currentSession.start)} (${currentSession.startType})<br>
                        End: ${formatDateTime(event.timestamp)} (${event.type})<br>
                        Duration: ${formatTime(duration)}
                    `;
                    timeSlotsDiv.appendChild(timeSlot);
                    currentSession = null;
                    sessionCount++;
                }
            }

            // Display all events in chronological order
            const eventsList = document.createElement('div');
            eventsList.className = 'mt-4';
            eventsList.innerHTML = '<h6>All Events</h6>';
            
            events.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'mb-2';
                eventDiv.innerHTML = `
                    <span class="badge event-badge ${event.type}">${event.type}</span>
                    ${formatDateTime(event.timestamp)}
                `;
                eventsList.appendChild(eventDiv);
            });
            
            timeSlotsDiv.appendChild(eventsList);
        }

        async function loadData(date) {
            try {
                const response = await fetch(`/data/screen_time_data/screen_time_${date}.json`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('No data available for this date');
                }
                const data = await response.json();
                displayData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('timeSlots').innerHTML = '<p class="text-danger">No data available for this date</p>';
            }
        }

        // Set up date picker
        const datePicker = document.getElementById('datePicker');
        datePicker.valueAsDate = new Date();
        
        // Load today's data by default
        loadData(new Date().toISOString().split('T')[0]);

        // Load data when date is changed
        datePicker.addEventListener('change', (e) => {
            loadData(e.target.value);
        });

        // Update current session time display
        setInterval(updateCurrentSessionDisplay, 1000);

        // Update data every 30 seconds
        setInterval(() => {
            const currentDate = datePicker.value;
            if (currentDate === new Date().toISOString().split('T')[0]) {
                loadData(currentDate);
            }
        }, 30000);

        // Clean up interval when page is closed
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html> 